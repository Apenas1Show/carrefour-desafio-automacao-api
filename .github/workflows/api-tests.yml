name: API Test Automation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Run API Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ğŸ” Verificar versÃµes
        run: |
          node --version
          npm --version

      - name: ğŸ§ª Executar testes
        env:
          BASE_URL: https://serverest.dev
          CI: true
        run: npm test
        continue-on-error: false

      - name: ğŸ“Š Gerar relatÃ³rio executivo
        if: always()
        run: |
          if [ -f "scripts/generate-summary.js" ]; then
            npm run report:summary || echo "Falha ao gerar relatÃ³rio executivo"
          fi

      - name: ğŸ“¤ Upload Playwright HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: reports/html-report/
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“¤ Upload Test Results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-json
          path: reports/test-results.json
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“¤ Upload JUnit Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-results
          path: reports/junit-results.xml
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“¤ Upload Allure Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: reports/allure-results/
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“¤ Upload Executive Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: executive-summary
          path: reports/EXECUTIVE_SUMMARY.md
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“Š Test Summary
        if: always()
        run: |
          echo "## ğŸ§ª Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "reports/EXECUTIVE_SUMMARY.md" ]; then
            cat reports/EXECUTIVE_SUMMARY.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Tests completed. Download artifacts for detailed results." >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    name: Notificar Status
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: âœ… Sucesso
        if: ${{ needs.test.result == 'success' }}
        run: |
          echo "âœ… Todos os testes passaram!"
          echo "ğŸ‰ Pipeline concluÃ­da com sucesso"

      - name: âŒ Falha
        if: ${{ needs.test.result == 'failure' }}
        run: |
          echo "âŒ Alguns testes falharam"
          echo "ğŸ” Verifique os artefatos"
          exit 1